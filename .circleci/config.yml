version: 2.1

orbs:
  node: circleci/node@5.0.2
  aws-cli: circleci/aws-cli@3.1.1

jobs:
  build-and-deploy:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout
      - aws-cli/setup

      # Install dependencies
      - run: npm ci

      # Build frontend Angular app
      - run: npm run build

      # Compile backend TypeScript
      - run: npm run build_api

      - run:
          name: Set up SSH key
          command: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 400 ~/.ssh/id_rsa
            ssh-keyscan ec2-3-149-229-145.us-east-2.compute.amazonaws.com >> ~/.ssh/known_hosts

      # Deploy frontend to S3
      - run: aws s3 sync ./dist/kirby-online-store/browser/ s3://udacity-bucket-doy

      # Deploy the entire build folder, database.json, migrations, and other files to EC2 and run migrations
      - run:
          name: Deploy Backend & Migrate DB on EC2
          command: |
            if [ ! -d ./build ]; then
              echo "Error: ./build directory does not exist. Check your build process."
              exit 1
            fi

            # Install PostgreSQL client before SSH (fix for 'psql: command not found')
            ssh -o StrictHostKeyChecking=no ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com \<< 'EOF'
            sudo yum update -y
            sudo yum install -y postgresql17
            psql --version
            EOF

            # SSH into EC2 and install Node.js 20.x
            ssh -o StrictHostKeyChecking=no ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com "curl -sL https://rpm.nodesource.com/setup_20.x | sudo -E bash - && sudo dnf install -y nodejs"

             ssh -o StrictHostKeyChecking=no ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com \
            "PGPASSWORD=postgres psql -h kirby-1.c3oi20aaakf6.us-east-2.rds.amazonaws.com -U postgres -d postgres -tc \"
              DO
              \$\$
              BEGIN
                IF NOT EXISTS (
                    SELECT FROM pg_database WHERE datname = 'kirby_store'
                ) THEN
                    EXECUTE 'CREATE DATABASE kirby_store';
                END IF;

                IF NOT EXISTS (
                    SELECT FROM pg_database WHERE datname = 'kirby_store_test'
                ) THEN
                    EXECUTE 'CREATE DATABASE kirby_store_test';
                END IF;
              END
              \$\$;\""

              
            # Verify the databases were created
            ssh -o StrictHostKeyChecking=no ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com "PGPASSWORD=postgres psql -h kirby-1.c3oi20aaakf6.us-east-2.rds.amazonaws.com -U postgres -d postgres -c '\l'"

            # Copy the backend files to EC2 instance
            scp -r ./build/* ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com:/home/ec2-user/app/
            scp ./database.json ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com:/home/ec2-user/app/
            scp -r ./migrations/ ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com:/home/ec2-user/app/
            scp ./package.json ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com:/home/ec2-user/app/

            # SSH into EC2 again, install dependencies, run migrations, and start the API
            ssh -o StrictHostKeyChecking=no ec2-user@ec2-3-149-229-145.us-east-2.compute.amazonaws.com "cd ~/app && npm install && npm run migrate-up && nohup npm run start_api &"

workflows:
  build-deploy:
    jobs:
      - build-and-deploy
